#!/usr/bin/env python3
import argparse
import importlib.util
import re
from pathlib import Path
from subprocess import run

SRC = Path.home() / "src"
COMMUNITY = SRC / "odoo"
ENTERPRISE = SRC / "enterprise"
THEMES = SRC / "design-themes"
UPGRADE_UTIL = SRC / "upgrade-util"
UPGRADE = SRC / "upgrade"

if __name__ == "__main__":
    parser = argparse.ArgumentParser(add_help=False)
    parser.add_argument("--branch", "-b", help="Odoo branch", required=True)
    parser.add_argument("--database", "-d", help="Database")
    parser.add_argument("--addons-path", help="Addon paths")
    parser.add_argument("--community", action="store_true")
    args, extra_args = parser.parse_known_args()

    if args.database:
        extra_args.extend(["--database", args.database])

    if args.branch:
        odoo_branch = args.branch
        odoo_release_file = next((COMMUNITY / odoo_branch).glob("*/release.py"))
        spec = importlib.util.spec_from_file_location("odoo_release", odoo_release_file)
        odoo_release = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(odoo_release)
        odoo_version = odoo_release.version

    odoo_version = float(".".join(re.findall(r"\d+", odoo_version)[0:2]))

    odoo_community = COMMUNITY / odoo_branch

    addons_path = args.addons_path.split(",") if args.addons_path else []
    if not addons_path:
        addons_path.append(str(odoo_community / "addons"))
        if not args.community:
            for path in [ENTERPRISE, THEMES]:
                for branch in (
                    odoo_branch,
                    (
                        "-".join(odoo_branch.split("-")[0:2])
                        if odoo_branch.startswith("saas-")
                        else odoo_branch.split("-")[0]
                    ),
                ):
                    p = path / branch
                    if p.exists():
                        # In 9.0, enterprise must be put before community in addons path,
                        # for the web from enterprise which overrides the web module from community
                        addons_path.insert(0, str(p))
                        break
    addons_path = ",".join(str(path) for path in addons_path)
    extra_args.extend(["--addons-path", addons_path])

    if "--upgrade-path" not in extra_args and odoo_version >= 13.0:
        extra_args.extend(["--upgrade-path", ",".join([str(UPGRADE_UTIL / "src"), str(UPGRADE / "migrations")])])
    if odoo_version < 11.0 and "--http-port" in extra_args:
        extra_args[extra_args.index("--http-port")] = "--xmlrpc-port"
    if odoo_version < 16.0 and "--gevent-port" in extra_args:
        extra_args[extra_args.index("--gevent-port")] = "--longpolling-port"
    if odoo_version < 8.0 and "--longpolling-port" in extra_args:
        extra_args.pop(extra_args.index("--longpolling-port") + 1)
        extra_args.pop(extra_args.index("--longpolling-port"))
    if odoo_version < 11.0 and args.database:
        extra_args.append(f"--db-filter=^({args.database})$")

    python_bin = "python3" if odoo_version >= 11.0 else "python2"
    odoo_bin_name = "odoo-bin" if odoo_version >= 10.0 else "openerp-server"
    odoo_bin = odoo_community / odoo_bin_name

    run([python_bin, "-m", "debugpy", "--listen", "0.0.0.0:5678", odoo_bin, *extra_args])
